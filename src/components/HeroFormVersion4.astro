---
import HeroCTATextVersion4 from "./HeroCTATextVersion4.astro";
import FormInput from "./FormInput.astro";
---

<style>
  @reference '../styles/global.css';

  .form-header {
    @apply text-[20px] md:text-[24px] font-bold text-rbd-secondary mb-6;
  }
  .form-container {
    @apply min-h-[65svh] md:min-h-[380px] flex flex-col justify-center;
  }
  .step {
    @apply flex flex-1 flex-col justify-center;
  }
  .hidden {
    @apply hidden;
  }
  .error-text {
    @apply text-red-600 text-sm mt-2;
  }
  .button:disabled {
    @apply opacity-50 cursor-not-allowed;
  }
  .loading-text {
    @apply text-sm text-rbd-primary mt-2;
  }
</style>

<div id="form4-hero-form-container" class="bg-[#FAFBFE] rounded-lg py-6 md:py-14 px-4 md:px-8">
  <div class="form-container">
    <!-- Step 1 -->
    <div id="form4-step1" class="step">
      <HeroCTATextVersion4 />
      <div class="mt-8 flex justify-center">

        <button
          id="form4-start-btn"
          class="button max-w-md w-full !text-2xl grid grid-cols-[auto_1fr_auto] items-center gap-2"
        >
              <svg class="size-8 animate-wiggle" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
              <span class="justify-self-center">Start</span>
              <span class="block w-8 h-8" aria-hidden="true"></span>
        </button>

      </div>
    </div>

    <!-- Step 2 -->
    <div id="form4-step2" class="step hidden">
      <h2 class="h2 form-header">Kwota Twoich zadłużeń:</h2>
      <form id="form4-step2-form" novalidate>
        <div class="space-y-[12px]">
          <label class="flex rounded-[12px] p-[12px] bg-white items-center">
            <input type="radio" name="debt_amount" value="do 30 tys. PLN" required class="w-5 h-5 text-rbd-primary focus:ring-rbd-primary border-gray-300" />
            <span class="ml-3 text-rbd-black font-semibold text-[14px] md:text-base">do 30 tys. PLN</span>
          </label>
          <label class="flex rounded-[12px] p-[12px] bg-white items-center">
            <input type="radio" name="debt_amount" value="30-100 tys. PLN" class="w-5 h-5 text-rbd-primary focus:ring-rbd-primary border-gray-300" />
            <span class="ml-3 text-rbd-black font-semibold text-[14px] md:text-base">30-100 tys. PLN</span>
          </label>
          <label class="flex rounded-[12px] p-[12px] bg-white items-center">
            <input type="radio" name="debt_amount" value="80-150 tys. PLN" class="w-5 h-5 text-rbd-primary focus:ring-rbd-primary border-gray-300" />
            <span class="ml-3 text-rbd-black font-semibold text-[14px] md:text-base">80-150 tys. PLN</span>
          </label>
          <label class="flex rounded-[12px] p-[12px] bg-white items-center">
            <input type="radio" name="debt_amount" value="150-300 tys. PLN" class="w-5 h-5 text-rbd-primary focus:ring-rbd-primary border-gray-300" />
            <span class="ml-3 text-rbd-black font-semibold text-[14px] md:text-base">150-300 tys. PLN</span>
          </label>
          <label class="flex rounded-[12px] p-[12px] bg-white items-center">
            <input type="radio" name="debt_amount" value="powyżej 300 tys. PLN" class="w-5 h-5 text-rbd-primary focus:ring-rbd-primary border-gray-300" />
            <span class="ml-3 text-rbd-black font-semibold text-[14px] md:text-base">powyżej 300 tys. PLN</span>
          </label>
        </div>
        <div class="flex justify-between gap-6 mt-8">
          <!-- <button type="button" id="form4-step2-prev" class="button-outline text-rbd-primary font-semibold inline-flex items-center">Wróć</button> -->
          <button type="button" id="form4-step2-next" class="button w-full">Kontynuuj</button>
        </div>
      </form>
    </div>

    <!-- Step 3 -->
    <div id="form4-step3" class="step hidden">
      <h2 class="h2 form-header">Twoje dane kontaktowe</h2>
      <form id="form4-contact-form" class="space-y-[12px]" novalidate>
        <FormInput id="form4-name" type="text" name="name" placeholder="Imię*" required={true} autocomplete="name" class="bg-white" />
        <div class="relative w-full">
          <FormInput type="tel" name="phone" placeholder="Telefon*" required={true} autocomplete="tel" class="bg-white" pattern="^(\+[0-9]{1,4})?[0-9]{8,10}$" title="Wprowadź poprawny numer telefonu" />
          <div id="form4-phone-error" class="error-text hidden text-red-500 text-xs mt-1 ml-4">Wprowadź poprawny numer telefonu</div>
        </div>
        <FormInput id="form4-email" type="email" name="email" placeholder="E-mail*" required={true} autocomplete="email" class="bg-white" />
        <p class="text-[10px] md:text-[12px] text-rbd-secondary opacity-90">Wyrażam zgodę na kontakt e-mailowy i telefoniczny.</p>
        <div class="flex justify-between gap-6 mt-8">
          <button type="button" id="form4-step3-prev" class="button-outline text-rbd-primary font-semibold inline-flex items-center">Wróć</button>
          <button type="submit" id="form4-submit-button" class="button w-full">Wyślij formularz</button>
          <p id="form4-loading-text" class="loading-text hidden">Wysyłanie formularza...</p>
        </div>
      </form>
    </div>

    <div id="form4-step4" class="step text-center hidden">
      <h2 class="h2 form-header">Dziękujemy za wypełnienie formularza.</h2>
      <p class="text-rbd-secondary">Analizujemy twoje zgłoszenie...</p>
    </div>
  </div>
</div>

<script is:inline type="module">
  (function initForm() {
    const steps = [
      document.getElementById("form4-step1"),
      document.getElementById("form4-step2"),
      document.getElementById("form4-step3"),
      document.getElementById("form4-step4"), 
    ];
    const formContainer = document.getElementById("form4-hero-form-container");
    let current = 0;

    function showStep(i) {
      steps.forEach((s, idx) => s.classList.toggle("hidden", idx !== i));
      const isMobile = window.matchMedia("(max-width: 767px)").matches;
      if (isMobile && i > 0) {
        setTimeout(() => {
          const header = document.querySelector("header");
          const headerHeight = header ? header.offsetHeight : 0;
          const containerPosition = formContainer.getBoundingClientRect().top + window.pageYOffset;
          window.scrollTo({ top: containerPosition - headerHeight, behavior: "smooth" });
        }, 50);
      }
    }
    showStep(current);

    const headerText = document.getElementById("form4-header-text");
    if (headerText) {
      headerText.addEventListener("click", () => { current = 1; showStep(current); });
    }

    document.getElementById("form4-start-btn").addEventListener("click", () => {
      current = 1;
      showStep(current);
    });

    document.getElementById("form4-step2-prev").addEventListener("click", () => {
      current = 0; showStep(current);
    });

    document.getElementById("form4-step2-next").addEventListener("click", () => {
      const form = document.getElementById("form4-step2-form");
      if (!form.reportValidity()) return;
      current = 2; showStep(current);
    });

    // document.getElementById("form4-step3-prev").addEventListener("click", () => {
    //   current = 1; showStep(current);
    // });

    function collectFormData() {
      const form = document.getElementById("form4-contact-form");
      const fd = new FormData(form);

      const rawName = (fd.get("name") || "").toString();
      const name = rawName.trim().split(" ").filter((x) => x).map((w) => w[0].toUpperCase() + w.slice(1).toLowerCase()).join(" ");

      const email = (fd.get("email") || "--").toString().trim();
      const phone = (fd.get("phone") || "--").toString().trim();
      const debt = document.querySelector('input[name="debt_amount"]:checked');

      return { name, email, phone, problems: [], ...(debt && { debt_amount: debt.value }) };
    }

    function mapFormDataToLead(formData) {
      const urlParams = new URLSearchParams(window.location.search);
      const props = [
        { name: "form_version", value: "rbd_com_header_alt", type: "string" },
        ...["utm_source", "utm_medium", "utm_campaign"]
          .map((k) => urlParams.get(k))
          .filter(Boolean)
          .map((v, i) => ({ name: ["utm_source", "utm_medium", "utm_campaign"][i], value: v, type: "string" })),
      ];

      const mapTag = {
        "do 30 tys. PLN": "Ma mniej niż 30k długu",
        "30-100 tys. PLN": "Ma 30-80k długu",
        "80-150 tys. PLN": "Ma 80-150k długu",
        "150-300 tys. PLN": "Ma 150-300k długu",
        "powyżej 300 tys. PLN": "Ma powyżej 300k długu",
      };

      const tags = [formData.debt_amount && mapTag[formData.debt_amount]].filter(Boolean);

      return {
        id: Math.floor(Date.now() / 1000),
        name: formData.name,
        email: formData.email,
        phone: formData.phone,
        note: null,
        address: null,
        city: null,
        state: null,
        zip: null,
        country: null,
        companyName: null,
        createdOn: Math.floor(Date.now() / 1000),
        properties: props,
        tags,
        subscribed: true,
        subscriberLists: [0, 236802010],
      };
    }

    document.getElementById("form4-contact-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const form = e.target;
      const submitButton = document.getElementById("form4-submit-button");

      const phoneInput = form.querySelector('input[name="phone"]');
      const phoneError = document.getElementById("form4-phone-error");
      const phoneRegex = /^(\+[0-9]{1,4})?[0-9]{8,10}$/;

      if (phoneInput && !phoneRegex.test(phoneInput.value)) {
        phoneError.classList.remove("hidden");
        return;
      } else if (phoneError) {
        phoneError.classList.add("hidden");
      }

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      submitButton.disabled = true;
      const loadingText = document.getElementById("form4-loading-text");
      loadingText.classList.remove("hidden");

      const formData = collectFormData();
      const lead = mapFormDataToLead(formData);
      current = 3;
      showStep(current);

      try {
        const res = await fetch("https://api.rodzinabezdlugow.pl/contact/leads", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(lead),
        });
        if (!res.ok) throw new Error(`Status ${res.status}`);

        loadingText.classList.add("hidden");
        setTimeout(() => window.open("/thank-you", "_self"), 2000);

      } catch (err) {
        console.error("Lead submission failed:", err);
        submitButton.disabled = false;
        loadingText.classList.add("hidden");
      }
    });
  })();
</script>
